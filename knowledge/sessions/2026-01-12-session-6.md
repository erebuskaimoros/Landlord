# Session 6: Phase 1 Slice 4 - Relationships & Business Logic

**Date:** 2026-01-12
**Focus:** Implementing entity relationships and core business logic workflows

## Summary

Implemented Slice 4 of Phase 1, connecting entities with proper relationships and adding key business logic for lease-to-unit status sync and tenant timeline tracking.

## Completed Tasks

### 1. Building Selection in Unit Form
- Added `building_id` to unit create schema (`src/lib/validations/unit.ts`)
- Updated unit form to show building dropdown when buildings exist (`src/components/forms/unit-form.tsx`)
- Updated unit actions to handle building_id on create/update (`src/app/(dashboard)/units/actions.ts`)
- Added Building column to units table with links to building detail page
- Units page now fetches buildings alongside units

### 2. Unit Status Auto-Update from Leases
- Created `syncUnitStatus()` helper function in lease actions
- Automatically sets unit to 'occupied' when active leases exist
- Automatically sets unit to 'vacant' when no active leases
- Triggers on lease create, update, and delete
- Handles unit changes during lease updates (syncs both old and new units)

### 3. Tenant Timeline Events
- Created timeline event validation schema (`src/lib/validations/timeline-event.ts`)
- Created timeline events service (`src/services/timeline-events.ts`)
- Created timeline actions (`src/app/(dashboard)/tenants/[id]/timeline-actions.ts`)
- Built timeline event form component (`src/components/timeline/timeline-event-form.tsx`)
- Built tenant timeline display component (`src/components/timeline/tenant-timeline.tsx`)
- Added timeline to tenant detail page with add/edit/delete functionality
- Auto-creates "Lease signed" event when active lease is created

### 4. Building Detail - Related Units
- Building detail page now fetches and displays units assigned to that building
- Shows unit address, status badge, and rental price
- Links to individual unit detail pages
- Empty state when no units assigned

### 5. Unit Detail - Active Lease Info
- Unit detail page now fetches active lease with tenant data
- Displays current tenant name, lease dates, monthly rent
- Link to full lease details
- Shows building association if unit belongs to a building
- Empty state for vacant units

### 6. Tenant Detail - Lease History
- Tenant detail page now fetches all leases for the tenant
- Displays lease history with unit address, status, dates, and rent
- Links to lease detail and unit detail pages
- Ordered by start date descending

## Files Changed/Created

### New Files
- `src/lib/validations/timeline-event.ts`
- `src/services/timeline-events.ts`
- `src/app/(dashboard)/tenants/[id]/timeline-actions.ts`
- `src/components/timeline/timeline-event-form.tsx`
- `src/components/timeline/tenant-timeline.tsx`

### Modified Files
- `src/lib/validations/unit.ts` - Added building_id
- `src/app/(dashboard)/units/actions.ts` - Handle building_id, revalidate buildings
- `src/components/forms/unit-form.tsx` - Building select dropdown
- `src/components/tables/units-table.tsx` - Building column display
- `src/app/(dashboard)/units/page.tsx` - Fetch buildings
- `src/app/(dashboard)/units/units-client.tsx` - Pass buildings to form/table
- `src/app/(dashboard)/units/[id]/page.tsx` - Fetch building and active lease
- `src/app/(dashboard)/units/[id]/unit-detail-client.tsx` - Display lease/building info
- `src/app/(dashboard)/leases/actions.ts` - Unit status sync, timeline events
- `src/app/(dashboard)/buildings/[id]/page.tsx` - Fetch units for building
- `src/app/(dashboard)/buildings/[id]/building-detail-client.tsx` - Display units list
- `src/app/(dashboard)/tenants/[id]/page.tsx` - Fetch leases
- `src/app/(dashboard)/tenants/[id]/tenant-detail-client.tsx` - Display lease history, timeline

## Remaining from Slice 4

### Building Expense Allocations (Deferred)
The building_unit_allocations table exists in the schema but UI was deferred as it's more complex:
- Requires percentage allocation management
- Should sum to 100% per building
- Will be useful when transaction splitting is implemented in Slice 5

## Next Steps (Slice 5)

1. Full field coverage for all entities
2. Units: property details, status management, notes
3. Tenants: emergency contact fields
4. Leases: security deposit, terms, documents
5. Transactions: expected vs actual amounts, running balance
6. Progressive disclosure prompts for units
