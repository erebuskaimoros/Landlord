# Session 1 - GPS-Based Auto-Navigation

> Date: 2026-01-19
> Focus: Implement auto-navigation to nearby units based on GPS location

## Summary

Implemented GPS-based auto-navigation for the mobile app that detects when users are physically at one of their property addresses and automatically navigates to that unit's detail page. The feature supports multiple nearby units (shows selection modal), works offline using cached coordinates, and includes user settings to enable/disable the feature.

## Work Done

- Created database migration to add `latitude`/`longitude` columns to units table
- Built location service with Haversine distance calculation and permission handling
- Created settings store with AsyncStorage persistence for feature toggle
- Updated SQLite cache schema to store unit coordinates for offline matching
- Implemented `useLocationNavigation` hook with foreground detection and 30s cooldown
- Built `NearbyUnitsModal` bottom sheet for multiple unit selection
- Integrated location navigation into root layout
- Added Location settings section in More tab with toggle switch
- Updated TypeScript types in both mobile and web apps

## Discoveries

- expo-location is already included in dependencies - no additional install needed
- AppState listener pattern works well for foreground detection in React Native
- SQLite partial indexes (`WHERE latitude IS NOT NULL`) are efficient for coordinate queries
- Haversine formula provides good accuracy for short distances (< 1km)

## Files Changed

| File | Change |
|------|--------|
| `supabase/migrations/00017_add_unit_geolocation.sql` | New migration for lat/lng columns |
| `mobile/src/services/location.ts` | New location service with distance calc |
| `mobile/src/store/settings.ts` | New settings store with AsyncStorage |
| `mobile/src/hooks/useLocationNavigation.ts` | New hook for location-based navigation |
| `mobile/src/components/location/NearbyUnitsModal.tsx` | New modal for multiple unit selection |
| `mobile/src/lib/offline/database.ts` | Added lat/lng to cached_units schema |
| `mobile/src/lib/offline/index.ts` | Exported getCachedUnitsWithCoordinates |
| `mobile/src/hooks/index.ts` | Exported useLocationNavigation |
| `mobile/src/types/database.ts` | Added lat/lng to Unit type |
| `mobile/app/_layout.tsx` | Integrated settings and location navigation |
| `mobile/app/(tabs)/more.tsx` | Added Location settings section |
| `app/src/types/database.ts` | Added lat/lng to Unit type (web app) |

## In Progress

None - session complete

## Next Steps

- [ ] Run `supabase db reset` to apply the new migration
- [ ] Add geocoding for existing unit addresses (manual or via API)
- [ ] Test on physical device at actual property location
- [ ] Consider adding optional edge function for batch geocoding (`supabase/functions/geocode-units`)
- [ ] Add unit tests for distance calculation and nearby unit filtering
