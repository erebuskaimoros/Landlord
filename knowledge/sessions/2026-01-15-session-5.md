# Session 5 - Fix Server/Client Import Error & Improve Add Lease UX

> Date: 2026-01-15
> Focus: Fixed build error from server-only imports in client components, created /leases/new route, improved UX for adding leases

## Summary

Fixed a critical build error caused by client components importing server-side code that uses `next/headers`. Created the missing `/leases/new` route for creating leases from the unit page. Improved UX by showing "Add Tenant" button when no tenants exist instead of leading users to a dead-end "Add Lease" form.

## Work Done

- Fixed server/client import error in `lease-documents.ts` service being imported into client components
- Created `uploadLeaseDocumentAction` server action to replace direct service import
- Inlined `validateFile` function in `document-upload.tsx` to avoid importing from server module
- Created `/leases/new` route with server and client components
- Added `defaultUnitId` prop to `LeaseForm` to pre-select unit from URL params
- Updated unit detail page to conditionally show "Add Tenant" or "Add Lease" based on tenant existence
- Improved empty state messaging to guide users through correct workflow

## Discoveries

- **Next.js Server/Client Boundary**: Even `import type` can cause issues if the module file imports server-only code - the entire module gets evaluated. Solution: keep server-only code in separate files or use server actions.
- **UX Pattern**: When an action requires prerequisites (leases need tenants), show the prerequisite action button instead of the final action to avoid dead-ends.

## Files Changed

| File | Change |
|------|--------|
| app/src/app/(dashboard)/leases/actions.ts | Added `uploadLeaseDocumentAction` server action |
| app/src/app/(dashboard)/leases/[id]/lease-detail-client.tsx | Use server action instead of direct service import |
| app/src/components/leases/document-upload.tsx | Inlined `validateFile` to avoid server module import |
| app/src/components/forms/lease-form.tsx | Added `defaultUnitId` prop |
| app/src/app/(dashboard)/leases/new/page.tsx | New - server component for /leases/new route |
| app/src/app/(dashboard)/leases/new/new-lease-client.tsx | New - client component with auto-opening form |
| app/src/app/(dashboard)/units/[id]/page.tsx | Added tenants count query, pass `hasTenants` prop |
| app/src/app/(dashboard)/units/[id]/unit-detail-client.tsx | Conditional "Add Tenant" vs "Add Lease" button |

## In Progress

None - session complete

## Next Steps

- [ ] Add a tenant to test the full lease creation flow
- [ ] Consider adding inline tenant creation from the lease form
- [ ] Test document upload functionality on lease detail page
- [ ] Review other pages for similar server/client import issues
