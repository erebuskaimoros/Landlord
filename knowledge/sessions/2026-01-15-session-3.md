# Session 3 - Mobile Offline Architecture

> Date: 2026-01-15
> Focus: Implementing offline-first architecture for mobile app

## Summary

Implemented complete offline architecture for the React Native mobile app, enabling field workers to use the app without connectivity and sync changes when back online.

## Work Done

### SQLite Cache System
- Created `mobile/src/lib/offline/database.ts` with expo-sqlite v16+ async API
- Schema includes: `cached_units`, `cached_tasks`, `cached_contractors`, `cached_tenants`, `cached_leases`, `cached_photos`
- JSON-serialized rows for flexible schema
- Indexed by `organization_id` for efficient queries
- `cache_metadata` table tracks last sync time per table

### Sync Queue System
- Created `mobile/src/lib/offline/sync-queue.ts` for offline write operations
- Queue items track: operation type, table, record ID, data, timestamp, status, retry count
- Max 3 retries before marking permanently failed
- Auto-sync when connection restored
- Sequential processing to maintain operation order

### Offline Store (Zustand)
- Created `mobile/src/store/offline.ts` for global offline state management
- Tracks: `isOnline`, `isSyncing`, `pendingSyncCount`, `lastSyncAt`
- `syncData(orgId)` fetches and caches all organization data
- `processQueue()` syncs pending changes to Supabase
- Network listener (NetInfo) triggers auto-sync on reconnect

### Offline-First Hooks
- Created `mobile/src/hooks/useOfflineData.ts` with React Query integration
- `useOfflineTasks()` - tasks with automatic cache fallback
- `useOfflineTask(id)` - single task fetch
- `useOfflineUnits()` / `useOfflineUnit(id)` - units
- `useOfflineContractors()` / `useOfflineContractor(id)` - contractors
- `useOfflineMutation()` - generic mutation hook that queues offline

### UI Components
- Created `mobile/src/components/ui/OfflineIndicator.tsx`
- `OfflineIndicator` - floating animated banner showing offline/pending status
- `OfflineBanner` - compact version for embedding in headers
- Auto-hides when online with no pending changes

### Screen Integration
- Updated Tasks screen to use `useOfflineTasks()` hook
- Added offline mode indicator in list header
- Updated Task Detail screen to use offline hooks
- Status updates queue offline and show confirmation alert

## Files Changed

| File | Change |
|------|--------|
| `mobile/src/lib/offline/database.ts` | SQLite cache schema and operations |
| `mobile/src/lib/offline/sync-queue.ts` | Sync queue management |
| `mobile/src/lib/offline/index.ts` | Exports for offline module |
| `mobile/src/store/offline.ts` | Zustand offline state store |
| `mobile/src/hooks/useNetworkState.ts` | Network state monitoring hook |
| `mobile/src/hooks/useOfflineData.ts` | Offline-first data hooks |
| `mobile/src/hooks/index.ts` | Hook exports |
| `mobile/src/components/ui/OfflineIndicator.tsx` | Offline UI components |
| `mobile/app/_layout.tsx` | Initialize offline store, add indicator |
| `mobile/app/(tabs)/tasks.tsx` | Use offline hooks, show offline banner |
| `mobile/app/(tabs)/camera.tsx` | Added lat/lng to photo upload |
| `mobile/app/tasks/[id].tsx` | Offline hooks, photo section with camera modal |
| `mobile/src/types/database.ts` | Added task_id, latitude, longitude to photos |
| `app/src/types/database.ts` | Same type updates for web app |
| `supabase/migrations/00015_add_task_photos.sql` | New migration for task_id on photos |
| `knowledge/mobile-app-plan.md` | Updated with offline + photo docs |

## Architecture Notes

### Data Flow (Online)
1. App fetches from Supabase via React Query
2. Data cached in SQLite automatically
3. UI renders fresh data

### Data Flow (Offline)
1. React Query attempts Supabase fetch
2. On failure, hooks return SQLite cached data
3. UI renders cached data with offline indicator

### Write Operations (Offline)
1. User triggers mutation (e.g., update task status)
2. If offline, change queued in `sync_queue` table
3. UI shows "Queued" confirmation
4. When online, queue processed sequentially
5. React Query caches invalidated on success

## Additional Work (Same Session)

### Photo Geolocation Fix
- Updated `camera.tsx` upload function to include `latitude` and `longitude` fields
- Updated database types in both mobile and web apps to include lat/lng fields

### Task Photos Feature
- Created migration `00015_add_task_photos.sql` to add `task_id` to photos table
- Updated `tasks/[id].tsx` with:
  - Query to fetch photos linked to the task
  - Photos section UI with horizontal scroll gallery
  - "Add Photo" button with camera modal
  - In-line photo capture and upload
  - Photo thumbnails with signed URL loading
- Photos captured from task detail automatically link to both the task and its unit

## Next Steps

- [ ] Test offline mode on physical device
- [ ] Add push notifications for task updates
- [ ] Create development build for full testing
- [ ] Production deployment with EAS
